#!/bin/sh
#
# Hybrid between cheat & tldr
# Uses:
# - cheat cmd name
# - tldr markdown files
# - FZF fuzzy search

: "${CHEAT_DIR:=$HOME/.config/tldr/}"
: ${CHEATPAGER:="mdless"}
: ${EDITOR:=vi}

platform() {
   case $(uname -s) in
      Darwin)                 echo "osx"    ;;
      Linux)                  echo "linux"  ;;
      SunOS)                  echo "sunos"  ;;
      CYGWIN*|MINGW32*|MSYS*) echo "windows" ;;
      *)                      echo "common" ;;
   esac
}

USAGE="
 cheat              Fuzzy select command cheat to view
 cheat -e           Fuzzy select command cheat to edit
 cheat -p platform  Fuzzy select command cheat to edit
 "

[ ! -d "$CHEAT_DIR" ] && {
   base_url="https://raw.githubusercontent.com/tldr-pages/tldr/master/pages"
   echo "Directory $CHEAT_DIR does not exists."
   echo "Downloading pages.."
   #TODO...
}

while [ "$1" ]; do
   case "$1" in
      -h|--help) echo "$USAGE" ; exit ;;
      -e) edit=yes ;;
      *) cmd="$1" ;;
   esac
   shift
done

cheatdir="$CHEAT_DIR"

# No cmd specified: select with FZF
[ "$cmd" ] || cmd=$(cd $CHEAT_DIR; fzf)

file=${CHEAT_DIR}/${cmd}

[ "$edit" ] && $EDITOR "$file" || {
   italic=$(   tput sitm   || tput ZH      ) # Start italic
   eitalic=$(  tput ritm   || tput ZH      ) # End italic
   sed "s/^\`/  \`/g;s/{{/$italic/g;s/}}/$eitalic/g" "$file" | $CHEATPAGER
   # $CHEATPAGER "$file"
}

